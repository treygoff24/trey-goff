# Auto-Handoff â€” 20251228-120507

**Project:** trey-goff
**Generated:** 2025-12-28 12:05:07

---

## Current Context

# Interactive World - Build Context

**Last Updated**: Phase 7 - Exterior + Main Hall (COMPLETE)

## Protocol Reminder (Re-read on every phase start)

**The Loop**: IMPLEMENT â†’ TYPECHECK â†’ LINT â†’ BUILD â†’ TEST â†’ REVIEW â†’ FIX â†’ REPEAT â†’ COMMIT

**Cross-agent checkpoints (mandatory):**
- After drafting implementation plan â†’ Codex reviews
- After completing each phase â†’ Dual code review (subagent + Codex)
- Before declaring complete â†’ Codex final cross-check
- Stuck in error loop (3+ attempts) â†’ Call Codex for perspective

**How to call Codex:**
```bash
codex exec \
  --model gpt-5.2-codex \
  --config model_reasoning_effort="xhigh" \
  --yolo \
  "<YOUR_TASK_PROMPT>"
```

**Quality gates before review:**
```bash
pnpm typecheck && pnpm lint && pnpm build
```

If context feels stale, re-read `AUTONOMOUS_BUILD_CLAUDE_v2.md` and this file.

---

## What This Is

Interactive 3D "secret level" at `/interactive` - a mansion with rooms mapping to site content:
- **Library**: Blog posts and book reviews as physical books
- **Gym**: Powerlifting PRs as plates on a bar + plaques
- **Study**: Holographic 3D knowledge graph
- **Projects Room**: Museum-like exhibits for projects
- **Exterior**: Mountains, O'Neill cylinders, Goff Industries mech

---

## Build Context

**Type**: Feature addition
**Spec location**: `/treygoff-interactive-world-spec-v1.2.md`
**Plan location**: `/IMPLEMENTATION_PLAN.md`

---

## Tech Stack

**Existing:**
- Framework: Next.js 15 (App Router) + TypeScript
- Styling: Tailwind CSS v4 with CSS-first tokens
- Content: Content Collections + MDX
- UI: shadcn/ui (Radix-based) + cmdk

**New for Interactive:**
- Rendering: React Three Fiber (R3F v9) + Three.js
- Physics: @react-three/rapier (collision only)
- Character: ecctrl (pmndrs capsule controller)
- Post-processing: @react-three/postprocessing
- State: Zustand (interactive-specific store)
- Knowledge Graph: r3f-forcegraph
- Pathfinding: recast-navigation-js or three-pathfinding (decide in Phase 1)

---

## Current Phase

Phase 9 - Library Room: Building the Library with interactive book visualization.

---

## Implementation Progress

- [x] Phase 0: Route Isolation + Entry Flow
- [x] Phase 1: R3F Infrastructure
- [x] Phase 2: Asset Pipeline + CI Gates
- [x] Phase 3: State Management + Telemetry
- [x] Phase 4: Loading UX + Character Controller
- [x] Phase 5: Camera + Interaction System
- [x] Phase 6: Chunk Streaming State Machine
- [x] Phase 7: Exterior + Main Hall
- [x] Phase 8: Content Manifests
- [ ] Phase 9: Library Room
- [ ] Phase 10: Gym Room
- [ ] Phase 11: Projects Room
- [ ] Phase 12: Post-Processing + Polish
- [ ] Phase 13: Mobile Optimization
- [ ] Phase 14: Settings + Accessibility
- [ ] Phase 15: QA + Launch Verification
- [ ] Phase 16: Codex Final Cross-Check + Launch

---

## Key Files

### Existing (to integrate with)
- `/app/layout.tsx` - Root layout with providers
- `/app/globals.css` - Tailwind v4 config and design tokens
- `/lib/fonts.ts` - Font configuration
- `/lib/utils.ts` - Shared utilities
- `/components/ui/StarfieldBackground.tsx` - Existing R3F patterns
- `/content-collections.ts` - Content Collections configuration

### New (to create)
- `/app/interactive/page.tsx` - Client-only entry point
- `/app/interactive/layout.tsx` - Minimal layout
- `/components/interactive/` - All 3D components
- `/lib/interactive/store.ts` - Zustand store
- `/lib/interactive/types.ts` - TypeScript types
- `/public/manifests/` - Runtime content manifests
- `/public/assets/chunks/` - GLB chunk files
- `/scripts/generate-interactive-manifests.ts` - Manifest generator

---

## Design Tokens (from globals.css)

- Background: #070A0F (bg-0), #0B1020 (bg-1)
- Surface: rgba(255,255,255,0.06), rgba(255,255,255,0.10)
- Text: rgba(255,255,255,0.92/0.72/0.52)
- Warm accent: #FFB86B
- Electric accent: #7C5CFF
- Fonts: Satoshi (UI), Newsreader (prose), Monaspace Neon (mono)

---

## Performance Targets

- FCF (First Controllable Frame): <5s on 50Mbps
- Desktop (M1 MacBook Air): 60fps at Medium tier
- Mobile (iPhone 12): 30fps at Low tier
- Memory: <500MB peak with 2 chunks loaded
- Normal site: Zero Three.js bytes in bundles

---

## Quality Tiers

| Setting | Low | Medium | High |
|---------|-----|--------|------|
| DPR | 1.0 | 1.5 | min(2.0, native) |
| Shadows | None | 1024px | 2048px |
| Post-FX | Minimal | Standard | Full |
| LOD Bias | Aggressive | Normal | Quality |

---

## Chunk State Machine

```
unloaded â†’ preloading â†’ loaded â†’ active â†’ dormant â†’ disposed
    â†‘                                         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- Door proximity (15m) â†’ preload target room
- Room entry â†’ activate chunk, mark previous dormant
- Memory pressure â†’ dispose oldest dormant (keep max 2)

---

## Hook Signatures

<!-- Add every custom hook with exact return type as created -->

### useInteractiveStore()
```typescript
Returns: {
  // Chunk state
  chunkStates: Map<ChunkId, ChunkState>;
  activeChunk: ChunkId | null;

  // Quality
  qualityTier: 'low' | 'medium' | 'high' | 'auto';
  setQualityTier: (tier: QualityTier) => void;

  // Settings
  settings: InteractiveSettings;
  updateSettings: (partial: Partial<InteractiveSettings>) => void;

  // Navigation
  currentRoom: RoomId | null;
  spawnPosition: Vector3 | null;
  setCurrentRoom: (room: RoomId, spawn?: Vector3) => void;
}
```

---

## Import Locations

<!-- Track non-obvious imports to prevent errors -->

- `cn` â†’ `@/lib/utils`
- `useReducedMotion` â†’ `@/hooks/useReducedMotion`

---

## Git State

**Branch:** `feature/interactive-3d-world`

**Uncommitted Changes:**
```
 M components/interactive/InteractiveWorld.tsx
 M components/interactive/rooms/MainHallRoom.tsx
 M components/interactive/rooms/index.tsx
 M public/manifests/assets.manifest.json
 M public/manifests/books.manifest.json
 M public/manifests/essays.manifest.json
 M public/manifests/lifts.manifest.json
 M public/manifests/projects.manifest.json
 M public/search-index.json
?? ACCESSIBILITY_CHECKLIST.md
?? AUTONOMOUS_BUILD_CLAUDE_v2.md
?? AUTONOMOUS_BUILD_CODEX_v2.md
?? CONTEXT_TEMPLATE.md
?? IMPLEMENTATION_PLAN_WRITING.md
?? "Journal of Special Jurisdictions. Issue II.pdf"
?? LEARNINGS.md
?? SPEC_QUALITY_CHECKLIST.md
?? SPEC_WRITING.md
?? components/interactive/rooms/LibraryRoom.tsx
?? thoughts/
```

**Recent Commits:**
```
2b3d39c    1 feat(interactive): add content manifest generation (Phase 8)    2    3 Manifest Types (lib/interactive/manifest-types.ts):    4 - EssaysManifest: id, slug, title, excerpt, tags, publishedAt, readingTime, status    5 - BooksManifest: id, title, author, rating, tier, blurb, topics, year, coverImage    6 - ProjectsManifest: id, title, summary, links, images, tags, status, type, featuredRank    7 - LiftsManifest: total + individual lift PRs with history    8    9 Generator Script (scripts/generate-interactive-manifests.ts):   10 - Reads essays/projects from Content Collections   11 - Reads books from content/library/books.json   12 - Reads lifts from data/lifts.json   13 - Graceful degradation for missing/malformed files   14 - Type-safe sorting with explicit Record types   15 - BookTier derived from status + rating (favorites/recommended/read/reading/want)   16   17 Data Files:   18 - Created data/lifts.json with powerlifting PR data structure   19   20 Build Integration:   21 - Added generate-manifests script to prebuild   22 - Output to public/manifests/*.manifest.json   23 - Runs after search index, before asset compression   24   25 Source Alignment:   26 - Spec /content/blog/ â†’ Actual /content/essays/ (named essays.manifest.json)   27 - Spec /content/books/ â†’ Actual /content/library/books.json   28 - Spec /content/projects/ â†’ Actual /content/projects/   29 - Spec /data/lifts.json â†’ Created data/lifts.json   30   31 ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)   32   33 Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
4569ded    1 feat(interactive): add Exterior and Main Hall rooms (Phase 7)    2    3 ExteriorRoom:    4 - Placeholder mansion facade with windows and door frame    5 - Sky dome with O'Neill cylinder sprites    6 - Mountain backdrop as simple cones    7 - Ground plane with path to mansion and grid overlay    8 - Goff Industries mech placeholder with idle animation    9 - Garage structure placeholder   10 - DoorTrigger to Main Hall with spawn position/rotation   11   12 MainHallRoom:   13 - Central hub connecting all rooms (20x25x8 units)   14 - Decorative pillars at corners   15 - Central pedestal with rotating holographic mansion   16 - Chandelier placeholder   17 - Door frames with labels for all connected rooms   18 - DoorTriggers to Exterior, Library, Gym, Projects   19 - Accent lighting near each door   20   21 Room Registry (rooms/index.tsx):   22 - Lazy-loaded room components for code splitting   23 - RoomConfig with spawn position/rotation, display name   24 - PlaceholderRoom component with return doors to Main Hall   25 - RoomRenderer with Suspense boundary   26 - Utility functions: getRoomSpawn, getRoomRotation, isRoomReady   27   28 PlayerController fixes:   29 - Single source of truth for yaw (passed to hooks as ref)   30 - Eliminate per-frame allocations for store updates   31 - Only allocate arrays when position/rotation changes   32 - Mobile getTarget returns ref directly (no clone)   33   34 InteractiveWorld integration:   35 - RoomRenderer reads currentRoom from store   36 - pendingTransition ref stores door activation info   37 - onSwap callback performs room swap during fade-to-black   38 - setTimeout cleanup on unmount   39 - RoomId type safety throughout   40   41 Type safety:   42 - Changed onDoorActivate callback to use RoomId instead of string   43 - Store additions: spawnPosition, spawnRotation setters   44 - Proper type propagation through all room components   45   46 ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)   47   48 Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
a21675e    1 feat(interactive): add chunk streaming state machine (Phase 6)    2    3 ChunkManager:    4 - State machine: unloaded â†’ preloading â†’ loaded â†’ active â†’ dormant â†’ disposed    5 - Watch preloading state and trigger actual loads    6 - Abort in-flight loads on dispose (even if chunk not yet stored)    7 - Check abort signal after load to dispose orphaned assets    8 - Memory pressure monitoring in debug mode    9   10 DoorTrigger:   11 - Proximity-based preloading (15m default distance)   12 - Activation zone for door interaction   13 - Reusable Vector3 ref to avoid per-frame allocation   14 - Debug visualization for preload/activation radii   15   16 TransitionOverlay:   17 - Fade to black overlay for room transitions   18 - Timeline: fading-out â†’ black â†’ fading-in â†’ idle   19 - onSwap callback for chunk swap during black frame   20 - Reduced motion support (instant transitions)   21   22 Store:   23 - Use fresh state for dormant chunk eviction (fixes max 2 limit)   24 - disposeChunk with timeout reset to unloaded   25   26 PlayerController:   27 - Add disableInput prop for room transitions   28   29 Integration:   30 - ChunkManager mounted in InteractiveWorld   31 - TransitionOverlay with useRoomTransition hook   32 - Player input disabled during transitions   33   34 ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)   35   36 Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
cac43b4    1 fix(interactive): Phase 5 revisions from Codex review    2    3 Camera System:    4 - Remove camera control from PlayerController (now in CameraController)    5 - Fix initial camera placement sign (+sin/+cos matching per-frame)    6 - Add multi-material transparent check in collision detection    7 - Skip ground/grid/player meshes in camera collision    8    9 Interaction System:   10 - Use canvas rect for coordinate calculation instead of window   11 - Attach event listeners to gl.domElement, not window   12 - Add passive: true to touchstart for mobile performance   13   14 InteractiveWorld:   15 - Add demo interactable cube with content overlay   16 - Use callback ref pattern for proper effect triggering   17 - Memoize handleSceneInteract to prevent effect re-runs   18 - Name ground/grid meshes for camera collision filtering   19   20 PlayerController:   21 - Update position/rotation every frame (not throttled)   22 - Only throttle telemetry (isMoving, recordInteraction)   23 - Name player group for collision filtering   24   25 ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)   26   27 Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
6d2ffd1    1 feat: add camera and interaction system (Phase 5)    2    3 - Add CameraController with third-person and first-person modes    4   - Tuple-based position input for stable React dependencies    5   - Lerp-based smooth following with reduced motion support    6   - Camera collision detection to prevent clipping through geometry    7    8 - Add InteractionSystem for hover detection and interaction    9   - Own raycaster ref to avoid mutating R3F's shared raycaster   10   - useKeyboardControls for E key with edge detection   11   - Touch handler for mobile tap-to-interact   12   - Highlight effect on hovered objects with emissive materials   13   - HTML-based interaction hints that scale with distance   14   15 - Add ContentOverlay for DOM-based content display   16   - Focus trap with Escape key handling   17   - aria-labelledby for screen reader accessibility   18   - Next.js Image with unoptimized for external URLs   19   20 - Integrate systems in InteractiveWorld   21   - CameraIntegration reads player position from store   22   - InteractionSystem wired (interactables placeholder)   23   - ContentOverlay ready for room components   24   25 - Add scale-in animation to globals.css   26   27 ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)   28   29 Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
```

---

## Resume Instructions

1. Re-read this handoff
2. Re-read CONTEXT.md if it exists
3. Check the implementation plan for current phase
4. Continue from where you left off

*Auto-generated before context compaction.*
